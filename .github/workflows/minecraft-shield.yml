name: Survivalcraft Server - Shield (Auto-Religamento)

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  minecraft-server-shield:
    runs-on: ubuntu-latest
    timeout-minutes: 720
    
    steps:
    - name: Checkout codigo
      uses: actions/checkout@v4
    
    - name: Setup Java 21
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Criar diretorio do servidor
      run: |
        mkdir -p ~/minecraft-server
        cd ~/minecraft-server
        cp -r $GITHUB_WORKSPACE/* . 2>/dev/null || true
    
    - name: Aceitar EULA
      run: |
        cd ~/minecraft-server
        echo "eula=true" > eula.txt
    
    - name: Baixar Paper 1.21.1
      run: |
        cd ~/minecraft-server
        if [ ! -f paper-1.21.1.jar ]; then
          echo "Baixando Paper 1.21.1..."
          curl -L -o paper-1.21.1.jar \
            "https://api.papermc.io/v2/projects/paper/versions/1.21.1/builds/128/downloads/paper-1.21.1-128.jar" \
            --progress-bar
        fi
        ls -lh paper-1.21.1.jar
    
    - name: Configurar server.properties
      run: |
        cd ~/minecraft-server
        cat > server.properties << 'EOF'
server-name=Survivalcraft
server-port=25565
server-ip=0.0.0.0
online-mode=false
gamemode=survival
difficulty=2
max-players=20
pvp=true
enable-command-blocks=true
spawn-protection=0
motd=Survivalcraft - Sao Paulo Brasil
level-name=world
level-seed=
level-type=minecraft:normal
enable-rcon=false
query.port=25565
enable-query=true
view-distance=10
simulation-distance=8
network-compression-threshold=256
max-tick-time=60000
EOF
        cat server.properties
    
    - name: Executar Shield Auto-Religamento
      run: |
        cd ~/minecraft-server
        chmod +x shield.py
        echo "Iniciando Shield (Auto-Religamento)..."
        python3 shield.py
    
    - name: Upload logs em caso de erro
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: server-shield-logs
        path: ~/minecraft-server/*.log
        retention-days: 7
