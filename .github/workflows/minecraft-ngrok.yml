name: Survivalcraft Server - ngrok AutomÃ¡tico

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  minecraft-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Accept EULA
      run: echo "eula=true" > eula.txt
    
    - name: Download Paper 1.21.1
      run: |
        echo "ðŸ“¥ Baixando Paper 1.21.1..."
        curl -L -o paper.jar "https://api.papermc.io/v2/projects/paper/versions/1.21.1/builds/128/downloads/paper-1.21.1-128.jar"
        if [ -f paper.jar ]; then
          echo "âœ… Paper baixado com sucesso"
          ls -lh paper.jar
        else
          echo "âŒ Erro ao baixar Paper"
          exit 1
        fi
    
    - name: Create Plugins Directory
      run: mkdir -p plugins
    
    - name: Create server.properties
      run: |
        cat > server.properties << 'EOF'
        online-mode=false
        server-port=25565
        max-players=20
        gamemode=survival
        difficulty=normal
        pvp=true
        white-list=false
        view-distance=10
        simulation-distance=8
        motd=\u00a76Survivalcraft - S\u00e3o Paulo, Brasil \u00a7e\u00a7lOFFLINE MODE
        level-seed=
        level-name=world
        level-type=minecraft\:normal
        allow-flight=false
        spawn-protection=16
        hardcore=false
        ops-only=false
        prevent-proxy-connections=false
        enable-query=false
        enable-rcon=false
        sync-chunk-writes=true
        network-compression-threshold=256
        max-tick-time=60000
        require-resource-pack=false
        hide-online-players=false
        enforce-secure-profile=false
        previews-chat=false
        use-native-transport=true
        EOF
        echo "âœ… server.properties criado"
    
    - name: Create ops.json
      run: |
        cat > ops.json << 'EOF'
        [
          {
            "uuid": "00000000-0000-0000-0000-000000000001",
            "name": "N0vakt",
            "level": 4,
            "bypassesPlayerLimit": true
          },
          {
            "uuid": "00000000-0000-0000-0000-000000000002",
            "name": "froskk",
            "level": 4,
            "bypassesPlayerLimit": true
          }
        ]
        EOF
        echo "âœ… ops.json criado"
    
    - name: Download ngrok
      run: |
        echo "ðŸ“¥ Baixando ngrok..."
        curl -L -o ngrok.zip "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip"
        unzip -o ngrok.zip
        chmod +x ngrok
        ./ngrok --version
        echo "âœ… ngrok baixado"
    
    - name: Start Minecraft Server with ngrok Tunnel
      run: |
        echo "ðŸš€ Iniciando Servidor Minecraft Survivalcraft com ngrok..."
        
        # Iniciar o servidor
        java -Xmx7G -Xms7G \
          -XX:+UseG1GC \
          -XX:MaxGCPauseMillis=200 \
          -XX:+ParallelRefProcEnabled \
          -XX:+UnlockDiagnosticVMOptions \
          -XX:G1SummarizeRSetStatsPeriod=1 \
          -jar paper.jar nogui > /tmp/server.log 2>&1 &
        
        SERVER_PID=$!
        echo "ðŸŽ® Servidor iniciado com PID: $SERVER_PID"
        
        # Aguardar o servidor iniciar
        echo "â³ Aguardando servidor iniciar..."
        STARTED=0
        for i in {1..120}; do
          if grep -q "Done (.*s)! For help, type" /tmp/server.log 2>/dev/null; then
            echo "âœ… Servidor iniciou com sucesso!"
            STARTED=1
            break
          fi
          if [ $((i % 20)) -eq 0 ]; then
            echo "   Tentativa $i/120..."
          fi
          sleep 1
        done
        
        if [ $STARTED -eq 0 ]; then
          echo "âŒ Servidor nÃ£o iniciou a tempo"
          echo "=== LOGS DO SERVIDOR ==="
          cat /tmp/server.log
          echo "========================"
          exit 1
        fi
        
        # Iniciar ngrok tunnel para Java (porta 25565)
        echo ""
        echo "ðŸŒ Iniciando tÃºnel ngrok para Java Edition..."
        ./ngrok tcp 25565 --log=stdout > /tmp/ngrok.log 2>&1 &
        NGROK_PID=$!
        echo "ðŸŒ ngrok iniciado com PID: $NGROK_PID"
        
        # Aguardar ngrok iniciar e capturar o endereÃ§o
        sleep 5
        
        # Tentar obter o endereÃ§o do ngrok via API
        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"[^"]*"' | head -1 | cut -d'"' -f4)
        
        if [ -z "$NGROK_URL" ]; then
          echo "âš ï¸  NÃ£o foi possÃ­vel obter URL do ngrok via API, tentando logs..."
          NGROK_URL=$(grep -o "tcp://[^ ]*" /tmp/ngrok.log | head -1)
        fi
        
        if [ -z "$NGROK_URL" ]; then
          echo "âš ï¸  URL do ngrok nÃ£o encontrada, aguardando mais..."
          sleep 5
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"[^"]*"' | head -1 | cut -d'"' -f4)
        fi
        
        # Extrair host e porta
        if [[ $NGROK_URL == tcp://* ]]; then
          NGROK_HOST=$(echo $NGROK_URL | sed 's|tcp://||' | cut -d: -f1)
          NGROK_PORT=$(echo $NGROK_URL | sed 's|tcp://||' | cut -d: -f2)
        else
          NGROK_HOST="localhost"
          NGROK_PORT="25565"
        fi
        
        # Mostrar informaÃ§Ãµes
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘   âœ… SERVIDOR SURVIVALCRAFT ONLINE! âœ…                â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘ ðŸŒ LocalizaÃ§Ã£o: SÃ£o Paulo, Brasil                     â•‘"
        echo "â•‘ ðŸ“± VersÃ£o: Paper 1.21.1                               â•‘"
        echo "â•‘ ðŸŽ¯ Modo: Offline (Pirata - sem autenticaÃ§Ã£o)          â•‘"
        echo "â•‘ ðŸ‘¥ MÃ¡ximo de Jogadores: 20                            â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘ ðŸ”Œ ENDEREÃ‡O PARA CONECTAR (Java Edition):             â•‘"
        echo "â•‘    Host: $NGROK_HOST                                    â•‘"
        echo "â•‘    Porta: $NGROK_PORT                                   â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘ ðŸ‘‘ Donos: N0vakt e froskk                             â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ðŸ“ Servidor aguardando conexÃµes por 6 horas..."
        echo "ðŸ”— EndereÃ§o ngrok: $NGROK_URL"
        echo ""
        
        # Manter o servidor rodando por 6 horas
        sleep 21600
        
        # Parar o servidor
        echo ""
        echo "ðŸ›‘ Parando servidor..."
        kill $SERVER_PID 2>/dev/null || true
        kill $NGROK_PID 2>/dev/null || true
        wait $SERVER_PID 2>/dev/null || true
        wait $NGROK_PID 2>/dev/null || true
        echo "âœ… Servidor parado. Workflow serÃ¡ reiniciado em 6 horas."
